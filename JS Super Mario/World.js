var canvas = document.getElementById('canvas');
var ctx = canvas.getContext('2d');
var gameRestart;
var filledSpaces = [];
var finish;
var leveldesign = 
[ 
    "########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################W############################################W############################################################################################H#######################E########################HH##########HHHH####HHHHHH#######################HHH#######HHHHHHHH############HHHHHH###HHHH######HHHH######HHHHHHHHH###########EHHHHHH#E#HHHH####EHHHHH#####################################################",
    "########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################W#########################################################################################################################################H#######################E########################HH##########HHHH####HHHHHH#######################HHH#######HHHHHHHH############HHHHHH###HHHH######HHHH######HHHHHHHHH###########EHHHHHH#E#HHHH####EHHHHH#####################################################",
    "##################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################H#######################E########################HH##########HHHH####HHHHHH#######################HHH#######HHHHHHHH############HHHHHH###HHHH######HHHH######HHHHHHHHH###########EHHHHHH#E#HHHH####EHHHHH#####################################################",
    "################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################E##############################################HHHH##############################################HHHH##################E########################E###HH#######E########HHHH########H#############HHHH##HH#######F###################HH#########H####HH###HH######HH###HHHH###HHH#####HHH#########H####HH###HH######HH#################HHH##########H####HH###HH######HH################HHHHE#####################################################",
    "#########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################W######################################W##################H#EH##############H########HHH###############E####HHHHHH######H####HH######HHH#HHH###F###E##########H##H#######EH###HHH######H#####H###H###F#####F####H##H#######FH##HHHH####################################################",
    emptyGame

];
var level = 0;

class block
{
    constructor(posx, posy, blockType_)
    {
        this.positionx = posx;
        this.positiony = posy;
        this.blockType = blockType_;
        var blck = Math.floor(posy/16) * 50 + Math.floor(posx / 16);
        if(blockType_ === "FNSH")
        {
            finish = blck;
        }
        if(blockType_ === "PPE"){
            ppeIntervalls.push(
            setInterval(function() {
                enemys.push(new enemy(blck-50)); 
                setTimeout(function(){
                    for (let index = 0; index < enemys.length; index++) {
                        if(enemys[index].id === blck-50)
                        {
                            enemys[index].die();
                            enemys.splice(index,1);
                            break;
                        }
                    }
                },60000);
            },5000));
        }
        filledSpaces.push(blck);
    }

    draw()
    {
        ctx.drawImage(this.GetType(),this.positionx,this.positiony);
    }

    clear()
    {
        ctx.clearRect(this.positionx,this.positiony,16,16);
    }

    GetType()
    {   
        var img = new Image();
        switch (this.blockType){
            case "BDN":
                img.src = 'Img/BDN.png';
                break;
            case "FNSH":
                img.src = 'Img/FNSH.png';
                break;
            case "NRML":
                img.src = 'Img/NRML.png';
                break;
            case "PPE":
                img.src = 'Img/PPE.png';
                break;
            case "QSTN":
                img.src = 'Img/QSTN.png';
                break;
        }
       return img;
    }

}

function IsFreeSpace(posx, posy, query)
{   
    var blockOL = Math.floor((posy + 0)/16) * 50 + Math.floor((posx + 0) / 16);
    var blockOR = Math.floor((posy + 0)/16) * 50 + Math.floor((posx + 16) / 16);
    var blockUL = Math.floor((posy + 16)/16) * 50 + Math.floor((posx + 0) / 16);
    var blockUR = Math.floor((posy + 16)/16) * 50 + Math.floor((posx + 16) / 16);

    var result = 1;

    for (var i = 0; i < filledSpaces.length; i++)
    {
        if(filledSpaces[i] === blockOL || filledSpaces[i] === blockOR ||
            filledSpaces[i] === blockUL || filledSpaces[i] === blockUR){
            result = 0;
        }
    }

    if((finish === blockOL || finish === blockOR ||
        finish === blockUL || finish === blockUR) && query.type === "player"){
        result = 2;
    }

    return result;
}

function GetBlock()
{
    canvas.addEventListener("click", function (evt) 
    {
        if(document.getElementById("EDIT").innerHTML==="RESUME")
        {
            var mousePos = getMousePos(canvas, evt);
            var blck = Math.floor(mousePos.y/16) * 50 + Math.floor(mousePos.x / 16);
            var tmpx = blck % 50;
            var tmpy = Math.floor(blck / 50);
            var blockType;
            alert(blck);

            switch (blcktyp) {

                case "BDN": blockType = "BDN"; mapdesign.push(blck); break;

                case "PPE": blockType = "PPE"; mapdesignPPE.push(blck); break;

                case "NRML": blockType = "NRML"; mapdesignNRML.push(blck); break;

                case "QSTN": blockType = "QSTN"; mapdesignQSTN.push(blck); break;

                case "ENEMY": 
                    enemydesign.push(blck); 
                    enemys.push(new enemy(blck));
                    enemys[enemys.length-1].draw();
                    break;
            }
            
            if(blcktyp != "ENEMY")
            {
            var tmpbck = new block(tmpx * 16, tmpy * 16,blockType);
            tmpbck.draw();
            }
        }
    }, false);
    
}

function getMousePos(canvas, evt) {
    var rect = canvas.getBoundingClientRect();

    return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
    };
}