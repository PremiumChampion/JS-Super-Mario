"use strict";
var gameRestart;
var filledSpaces = [];
var finish;
var leveldesign = [
    "####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################W###############################################################################################################################################################W###########W###########################################################W###W###############################W############W########################################################E#########F##E##E#####F###############################F##########################################F##HHH#######HHHHHHHHH#HHHHHHHHHH######################HHHHHHHHHH#################################HHHHHHHHH######HHHHHHHHHHHHHHHHHHHHHH###E################HHHHHHHHHH#######################F#########HHHHHHHHHH####HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH##F#######HHHHHHHHHHHH####################HHHHHHHHHHHHHHHHHHHHHHH##HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH##HHHHHHHHHHHHHH##########################################################################################################",
    "###########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################W##########################W###########################################################W##W##############################W#######################################W###################################################W###############################WW###############################################################################W#########################################################################F###################F##############################E############################E####E##########HHHHH##F##############HHHHH#############################HHHHF#################E##F###HHHHHHHHHHHHHHHHHHHHHHHHH#E#####HHHHHHHHHHH############FE######HHHHHHH#HHHHHHHH#############HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH###E#E####HHHHHHHHHHHHHHHHHHHHHHHHHH###########HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH#######################################################################################################",
    "######################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################W############W##############W##################################################################################################################################################################W#############################W########################W#######W##W##############################F###########################################E#################E##############################HHHHHHHHH###EF#################E#############FE##HHHHH############HHHHHHH###F#######################HHHHHHHHH####HHHHH###########HHHHHHH####E##FHHHHHHHHHHH###########HHHHHHHHHHHHH####################HHHHHHHHHHHE##HHHHHH######E###HHHHHHHHH###HHHHHHHHHHHHHHH###F#####HHHHHHHHHHHHHHH##################HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH#HHHHHHHHHHHHHHHHHHHHHHH################################################################################################################",
    "########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################W################################################################################################################################################################################W##W###############W#########################################W#######################################################W#########W#################################################W############################################F##################FF###############################################################################HH#################HHH#F##E############E##FE########################################################HHH###########E####HHHHHHHHHHH###E######HHHHH########################HHHHHHHHHHHHH#############HHHHHHHHHHH#####HHHHHHHHHHHHHHHHHHHH###HHHH##HHHHH###############F###E####HHHHHHHHHHHHH######HH##HHHHHHHHHHHHHHHHHH#HHHHHHHHHHHHHHHHHHHH###HHHHH#HHHHH##HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH#######################################################################################################",
    "#####################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################W#########################################################W###############W############################################################################################################W##################################################################################################################################################E###E#######F###################E###############################################################HHHHHHHHHHHHHHHHHHHHHHH###F######F###HHHHHHH########################HHHHHH#######E##F#####FE####F###HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH#HHHHHH#######HHHHHHH##E#HHHHHHHHHHHHHHH#HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH######HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH#######################################################################################################"
];

var level = 0;

class block {
    constructor(posx, posy, blockType_) {
        this.positionx = posx;
        this.positiony = posy;
        this.blockType = blockType_;
        var blck = Math.floor(posy / 16) * 100 + Math.floor(posx / 16);

        if (blockType_ === "FNSH") {
            finish = blck;
        }

        if (blockType_ === "PPE") {
            ppeIntervalls.push(
                setInterval(function () {
                    if (mario.HasBuff() != "FREEZE") {
                        enemys.push(new enemy(blck - 100));
                        setTimeout(function () {
                            for (let index = 0; index < enemys.length; index++) {
                                if (enemys[index].id === blck - 100) {
                                    enemys[index].die();
                                    enemys.splice(index, 1);
                                    break;
                                }
                            }
                        }, 60000);
                    }
                }, 5000));
        }

        filledSpaces.push(blck);
    }

    draw() {
        ctx.drawImage(this.GetType(), this.positionx, this.positiony);
    }

    clear() {
        ctx.clearRect(this.positionx, this.positiony, 16, 16);
    }

    GetType() {
        var img = new Image();
        switch (this.blockType) {
            case "BDN":
                img.src = 'Img/BDN.png';
                break;
            case "FNSH":
                img.src = 'Img/FNSH.png';
                break;
            case "NRML":
                img.src = 'Img/NRML.png';
                break;
            case "PPE":
                img.src = 'Img/PPE.png';
                break;
            case "QSTN":
                img.src = 'Img/QSTN.png';
                break;
        }
        return img;
    }

}

function IsFreeSpace(posx, posy, query) {

    if(query.type === "player"){
        posy = posy -2;
    }else{
        posy--;
    }

    if(posx > 1){
        posx--;
    }

    var blockOL = Math.floor((posy) / 16) * 100 + Math.floor((posx) / 16);
    var blockOR = blockOL + 1;
    var blockUR = blockOL + 100;
    var blockUL = blockOL + 101;
    var result = 1;

    for (var i = 0; i < filledSpaces.length; i++) {

        if (filledSpaces[i] === blockOL || filledSpaces[i] === blockOR || filledSpaces[i] === blockUL || filledSpaces[i] === blockUR) {
            result = 0;
        }

        if (query.type === "boss" && query.walkingDirection === "RIGHT") {
            if (filledSpaces[i] === blockOL || filledSpaces[i] === blockOR ||
                filledSpaces[i] === blockUL - 2 || filledSpaces[i] === blockUR) {
                result = 0;
            }
        }
    }
    
    if ((finish === blockOL || finish === blockOR ||
        finish === blockUL || finish === blockUR) && query.type === "player") {
            result = 2;
        }

    return result;
}


function GetBlock() {

    canvas.addEventListener("click", function (evt) {

        if (document.getElementById("EDIT").innerHTML === "RESUME") {

            var mousePos = getMousePos(canvas, evt);
            var blck = Math.floor(mousePos.y / 16) * 100 + Math.floor(mousePos.x / 16);
            var tmpx = blck % 100;
            var tmpy = Math.floor(blck / 100);
            var blockType;

            switch (blcktyp) {

                case "BDN":
                    blockType = "BDN";
                    mapdesign.push(blck);
                    break;

                case "PPE":
                    blockType = "PPE";
                    mapdesignPPE.push(blck);
                    break;

                case "NRML":
                    blockType = "NRML";
                    mapdesignNRML.push(blck);
                    break;

                case "QSTN":
                    blockType = "QSTN";
                    mapdesignQSTN.push(blck);
                    break;

                case "ENEMY":
                    enemydesign.push(blck);
                    enemys.push(new enemy(blck));
                    enemys[enemys.length - 1].draw();
                    break;
            }

            if (blcktyp != "ENEMY") {
                var tmpbck = new block(tmpx * 16, tmpy * 16, blockType);
                tmpbck.draw();
            }
        }
    }, false);

}

function getMousePos(canvas, evt) {

    var rect = canvas.getBoundingClientRect();

    return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
    };
}